name: Hourly Crypto Pipeline

on:
  schedule:
    - cron: '0 * * * *' # Run at the top of every hour
  workflow_dispatch: # Allows you to run it manually to test

jobs:
  build_and_run:
    runs-on: ubuntu-latest

    env:
      SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
      SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
      SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
      SNOWFLAKE_WAREHOUSE: COMPUTE_WH
      SNOWFLAKE_DATABASE: FINANCE_LAKE
      SNOWFLAKE_SCHEMA: RAW
      SNOWFLAKE_TABLE: MARKET_DATA
      COINGECKO_API_KEY: ${{ secrets.COINGECKO_API_KEY }}
      COINGECKO_API_URL: "https://api.coingecko.com/api/v3/coins/markets"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          pip install pandas snowflake-connector-python[pandas] requests tenacity python-dotenv dbt-snowflake

      - name: 1. Run Ingestion (Python)
        run: python scripts/run_pipeline.py

      - name: 2. Configure dbt Profile
        run: |
          mkdir -p ~/.dbt
          printf "dbt_finance:\n  target: dev\n  outputs:\n    dev:\n      type: snowflake\n      account: ${{ secrets.SNOWFLAKE_ACCOUNT }}\n      user: ${{ secrets.SNOWFLAKE_USER }}\n      password: ${{ secrets.SNOWFLAKE_PASSWORD }}\n      role: TRANSFORMER_ROLE\n      database: FINANCE_LAKE\n      warehouse: COMPUTE_WH\n      schema: ANALYTICS\n      threads: 1\n" > ~/.dbt/profiles.yml
      - name: 3. Run Transformation (dbt)
        run: |
          cd dbt_finance
          dbt deps
          dbt run
          dbt test
